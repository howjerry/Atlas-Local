id: atlas/security/python/command-injection
name: OS Command Injection via Shell Execution
description: >
  Detects potential command injection vulnerabilities where user-controllable
  data may be passed to OS command execution functions such as os.system,
  os.popen, or subprocess functions invoked with shell=True. An attacker
  can inject arbitrary shell commands, leading to full system compromise.
severity: critical
confidence: high
category: security
language: Python
cwe_id: CWE-78
pattern: |
  [
    (call
      function: (attribute
        object: (identifier) @_mod
        attribute: (identifier) @_method
        (#match? @_mod "^os$")
        (#match? @_method "^(system|popen)$"))
      arguments: (argument_list
        (_) @_first_arg))
    @match

    (call
      function: (attribute
        object: (identifier) @_mod2
        attribute: (identifier) @_method2
        (#match? @_mod2 "^subprocess$")
        (#match? @_method2 "^(call|run|Popen|check_call|check_output)$"))
      arguments: (argument_list
        (_) @_first_arg2
        (keyword_argument
          name: (identifier) @_kwname
          value: (true) @_kwval
          (#eq? @_kwname "shell"))))
    @match
  ]
remediation: >
  Avoid using os.system and os.popen entirely. For subprocess functions,
  never use shell=True with untrusted input. Instead, pass commands as a list
  of arguments without shell=True. For example, replace
  subprocess.run(f"ls {user_input}", shell=True) with
  subprocess.run(["ls", user_input]). If shell features are genuinely needed,
  use shlex.quote to sanitize all user-provided arguments.
references:
  - https://cwe.mitre.org/data/definitions/78.html
  - https://cheatsheetseries.owasp.org/cheatsheets/OS_Command_Injection_Defense_Cheat_Sheet.html
  - https://owasp.org/www-community/attacks/Command_Injection
tags:
  - command-injection
  - injection
  - owasp-top-10
  - a03-injection
metadata:
  compliance:
    - framework: owasp-top-10-2021
      requirement: "A03:2021"
      description: Injection
    - framework: pci-dss-4.0
      requirement: "6.2.4"
      description: Prevention of Common Software Attacks
    - framework: nist-800-53
      requirement: SI-10
      description: Information Input Validation
version: 1.0.0
