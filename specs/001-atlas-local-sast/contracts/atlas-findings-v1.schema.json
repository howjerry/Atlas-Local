{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://atlas-local.dev/schemas/atlas-findings-v1.0.0.json",
  "title": "Atlas Findings Report v1.0.0",
  "description": "Machine-readable scan report produced by Atlas Local SAST engine.",
  "type": "object",
  "required": ["schema_version", "scan", "findings", "gate_result"],
  "additionalProperties": false,
  "properties": {
    "schema_version": {
      "type": "string",
      "const": "1.0.0",
      "description": "Report schema version (SemVer)."
    },
    "scan": {
      "$ref": "#/$defs/ScanMetadata"
    },
    "findings": {
      "type": "array",
      "items": { "$ref": "#/$defs/Finding" },
      "description": "All findings, sorted by (file_path, start_line, start_col, rule_id)."
    },
    "findings_count": {
      "$ref": "#/$defs/FindingsSummary"
    },
    "gate_result": {
      "$ref": "#/$defs/GateResult"
    },
    "gate_details": {
      "$ref": "#/$defs/GateDetails"
    },
    "baseline_diff": {
      "$ref": "#/$defs/BaselineDiff"
    },
    "stats": {
      "$ref": "#/$defs/ScanStats"
    }
  },
  "$defs": {
    "ScanMetadata": {
      "type": "object",
      "required": ["id", "engine_version", "target_path", "files_scanned", "languages_detected", "rules_version", "config_hash"],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "description": "Deterministic scan ID (SHA-256 hex)."
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 scan start time. Omitted by default for determinism."
        },
        "engine_version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+",
          "description": "Atlas engine SemVer version."
        },
        "target_path": {
          "type": "string",
          "description": "Absolute path of the scanned directory."
        },
        "files_scanned": {
          "type": "integer",
          "minimum": 0
        },
        "files_skipped": {
          "type": "integer",
          "minimum": 0
        },
        "languages_detected": {
          "type": "array",
          "items": { "$ref": "#/$defs/Language" }
        },
        "rules_version": {
          "type": "string",
          "description": "Hash of all active rule versions."
        },
        "config_hash": {
          "type": "string",
          "description": "Hash of scan configuration for determinism verification."
        },
        "policy_applied": {
          "type": "string",
          "description": "Policy file(s) used, if any."
        },
        "baseline_applied": {
          "type": "string",
          "description": "Baseline file used, if any."
        }
      }
    },
    "Finding": {
      "type": "object",
      "required": ["fingerprint", "rule_id", "severity", "category", "file_path", "line_range", "snippet", "description", "remediation", "analysis_level", "confidence"],
      "additionalProperties": false,
      "properties": {
        "fingerprint": {
          "type": "string",
          "pattern": "^[a-f0-9]{64}$",
          "description": "SHA-256 hex of (rule_id + relative_path + normalized_snippet)."
        },
        "rule_id": {
          "type": "string",
          "pattern": "^atlas/",
          "description": "Rule identifier, e.g. atlas/security/typescript/sql-injection."
        },
        "severity": {
          "$ref": "#/$defs/Severity"
        },
        "category": {
          "$ref": "#/$defs/Category"
        },
        "cwe_id": {
          "type": "string",
          "pattern": "^CWE-\\d+$",
          "description": "CWE identifier, e.g. CWE-89."
        },
        "file_path": {
          "type": "string",
          "description": "Relative path from scan root (forward slashes, no leading ./)."
        },
        "line_range": {
          "$ref": "#/$defs/LineRange"
        },
        "snippet": {
          "type": "string",
          "description": "Source code snippet. Masked for secrets category."
        },
        "description": {
          "type": "string"
        },
        "remediation": {
          "type": "string"
        },
        "analysis_level": {
          "$ref": "#/$defs/AnalysisLevel"
        },
        "confidence": {
          "$ref": "#/$defs/Confidence"
        },
        "status": {
          "$ref": "#/$defs/FindingStatus",
          "description": "Present only when a baseline is applied."
        },
        "metadata": {
          "type": "object",
          "description": "Extensible key-value metadata (taint paths, entropy scores, etc.)."
        }
      }
    },
    "LineRange": {
      "type": "object",
      "required": ["start_line", "start_col", "end_line", "end_col"],
      "additionalProperties": false,
      "properties": {
        "start_line": { "type": "integer", "minimum": 1 },
        "start_col": { "type": "integer", "minimum": 1 },
        "end_line": { "type": "integer", "minimum": 1 },
        "end_col": { "type": "integer", "minimum": 1 }
      }
    },
    "FindingsSummary": {
      "type": "object",
      "required": ["critical", "high", "medium", "low", "info", "total"],
      "additionalProperties": false,
      "properties": {
        "critical": { "type": "integer", "minimum": 0 },
        "high": { "type": "integer", "minimum": 0 },
        "medium": { "type": "integer", "minimum": 0 },
        "low": { "type": "integer", "minimum": 0 },
        "info": { "type": "integer", "minimum": 0 },
        "total": { "type": "integer", "minimum": 0 }
      }
    },
    "GateResult": {
      "type": "object",
      "required": ["status"],
      "additionalProperties": false,
      "properties": {
        "status": {
          "type": "string",
          "enum": ["PASS", "FAIL", "WARN"]
        }
      }
    },
    "GateDetails": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "thresholds_breached": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["severity", "threshold", "actual"],
            "properties": {
              "severity": { "$ref": "#/$defs/Severity" },
              "category": { "$ref": "#/$defs/Category" },
              "threshold": { "type": "integer" },
              "actual": { "type": "integer" }
            }
          }
        }
      }
    },
    "BaselineDiff": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "new_count": { "type": "integer", "minimum": 0 },
        "baselined_count": { "type": "integer", "minimum": 0 },
        "resolved_count": { "type": "integer", "minimum": 0 }
      }
    },
    "ScanStats": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "duration_ms": { "type": "integer", "minimum": 0 },
        "cache_hits": { "type": "integer", "minimum": 0 },
        "cache_misses": { "type": "integer", "minimum": 0 },
        "cache_hit_rate": { "type": "number", "minimum": 0, "maximum": 1 },
        "parse_failures": { "type": "integer", "minimum": 0 },
        "rules_evaluated": { "type": "integer", "minimum": 0 },
        "timing": {
          "type": "object",
          "properties": {
            "discovery_ms": { "type": "integer", "minimum": 0 },
            "parsing_ms": { "type": "integer", "minimum": 0 },
            "analysis_ms": { "type": "integer", "minimum": 0 },
            "reporting_ms": { "type": "integer", "minimum": 0 }
          }
        }
      }
    },
    "Severity": {
      "type": "string",
      "enum": ["critical", "high", "medium", "low", "info"]
    },
    "Category": {
      "type": "string",
      "enum": ["security", "quality", "secrets"]
    },
    "AnalysisLevel": {
      "type": "string",
      "enum": ["L1", "L2", "L3"]
    },
    "Confidence": {
      "type": "string",
      "enum": ["high", "medium", "low"]
    },
    "FindingStatus": {
      "type": "string",
      "enum": ["new", "baselined", "resolved"]
    },
    "Language": {
      "type": "string",
      "enum": ["typescript", "javascript", "java", "python", "go", "csharp"]
    }
  }
}
